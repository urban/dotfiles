#!/usr/bin/env bash
#
# Brew and Cask shell script
#
# This file:
#
# More info:
#  - https://github.com/urban/dotfiles
#
# Author:
#  - Urban Faubion (urban.faubion@gmail.com)
#
# Licensed under MIT
# Copyright (c) 2015 Urban Faubion (urban.faubion@gmail.com)

### Configuration
#####################################################################

if [[ "$1" != "" ]]; then cat <<HELP

Usage: $(basename "$0")

See the README for documentation.
https://github.com/urban/dotfiles

Copyright (c) 2015 Urban Faubion
Licensed under the MIT license.
HELP
exit;
fi

# exit on error
set -o errexit
# exit when trying to use undeclared variables
set -o nounset

### Constants, Variables and Functions
#####################################################################

# Homebrew taps
TAPS=(
  homebrew/versions
  # Cask
  caskroom/versions
)

# Homebrew formulas
FORMULAS=(
  # Install GNU core utilities (those that come with OS X are outdated)
  coreutils
  # Install some other useful utilities like `sponge`
  moreutils
  # Install GNU `find`, `locate`, `updatedb`, and `xargs`, `g`-prefixed
  findutils
  # Install GNU `sed`, overwriting the built-in `sed`
  gnu-sed --default-names
  # Install Bash 4
  bash
  bash-completion
  # Install wget with IRI support
  wget --enable-iri
  # Install more recent versions of some OS X tools
  vim --override-system-vi
  homebrew/dupes/grep
  # Install other useful binaries
  git
  git-extras
  md5sha1sum
	nmap
  rename
  tmux
  tree
  webkit2png
  youtube-dl
  z
  # Install development tools
  chruby
  flow
  nvm
  phantomjs
  ruby-install
  watchman
  # Install Cask
  caskroom/cask/brew-cask
)

# Homebrew casks
CASKS=(
  # essential
  adium
  caffeine
  dropbox
  1password
  # dev
  arduino
  atom
  charles
  heroku-toolbelt
  imageoptim
  iterm2
  macvim
  mongodb
  sublime-text3
  transmission
  transmit
  vagrant
  virtualbox
  real-vnc
  # utils
  bittorrent-sync
  divvy
  handbrake
  rightzoom
	sdformatter
  the-unarchiver
  vlc
  # browsers
  firefox
  google-chrome
  google-chrome-canary
  # others
  skype
  calibre
  gitter
  hipchat
  mapbox-studio
  sketch
  sketch-beta
  slack
)

# quick look plugins (https://github.com/sindresorhus/quick-look-plugins)
QUICKLOOK=(
  qlcolorcode
  qlstephen
  qlmarkdown
  quicklook-json
  qlprettypatch
  quicklook-csv
  betterzipql
  webpquicklook
  suspicious-package
)

function log_message()  { echo -e "\n\033[1m$@\033[0m"; }
function log_success()  { echo -e " \033[1;32m✔\033[0m  $@"; }
function log_error()    { echo -e " \033[1;31m✖\033[0m  $@"; }

### Main
#####################################################################

# Finish.
function finish() {
  # Cleanup.
  local status=$?
  if [ $status != 0 ]; then
    echo -e "\033[1;31mError!"
  else
  echo -e "\033[1;32mFinished!"
  fi
}
trap finish EXIT

# Start.
log_message "Installing Homebrew and Cask"

# Install Homebrew if it doesn't exist
if ! hash brew 2>/dev/null; then
  echo "Installing Homebrew"
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Manually remove the brew cache, since that is the only way to force
# `brew cask install` to grab the latest versions of its recipes.
# https://github.com/phinze/homebrew-cask/issues/309#issuecomment-32470815
rm -rf "$(brew --cache)" && mkdir -p "$(brew --cache)"

# Remove any outdated versions from the cellar
brew cleanup --force

# Make sure we’re using the latest Homebrew
brew update

# Upgrade any already-installed formulae
brew upgrade --all

# Add additional formulae lookup repos
brew tap ${TAPS[@]}

# Install formulas
brew install ${FORMULAS[@]}

# Setup info
echo "Don't forget to add \`/usr/local/bin/bash to /etc/shells\` before running \`chsh\`."
echo "Don't forget to add \`\$(brew --prefix coreutils)/libexec/gnubin\` to \`\$PATH\`."

# Install casks
brew cask install ${CASKS[@]}

# Install Quicklook plugins
brew cask install ${QUICKLOOK[@]}

# Force `qlmanage` to relaod Generators list
qlmanage -r

# Remove outdated versions from the cellar
brew cleanup

# Symlink all installed "application" packages for into /Applications.
brew linkapps
