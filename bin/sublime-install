#!/usr/bin/env bash
#
# Sublime shell script
#
# This file:
#  - Creates the Sublime Text 3 User directory if it doesn't already exist.
#  - Checks if the User directory is a symlink and if not:
#    - Copies any User files into the ~/.dotfiles/sublime/ if they aren't already present.
#    - Removes the User directory.
#    - Symlinks the ~/.dotifles/sublime/ to the User directory.
#
# More info:
#  - https://github.com/urban/dotfiles
#
# Author:
#  - Urban Faubion (urban.faubion@gmail.com)
#
# Licensed under MIT
# Copyright (c) 2015 Urban Faubion (urban.faubion@gmail.com)

### Configuration
#####################################################################

if [[ "$1" != "" ]]; then cat <<HELP

Usage: $(basename "$0")

See the README for documentation.
https://github.com/urban/dotfiles

Copyright (c) 2015 Urban Faubion
Licensed under the MIT license.
HELP
exit;
fi

# exit on error
set -o errexit
# exit when trying to use undeclared variables
set -o nounset

### Constants, Variables and Functions
#####################################################################
DOT_SUBLIME=~/.dotfiles/sublime
INSTALLED_PACKAGES=~/Library/Application\ Support/Sublime\ Text\ 3/Installed\ Packages
USER_PACKAGES=~/Library/Application\ Support/Sublime\ Text\ 3/Packages/User

function log_message()  { echo -e "\n\033[1m$@\033[0m"; }
function log_success()  { echo -e " \033[1;32m✔\033[0m  $@"; }
function log_error()    { echo -e " \033[1;31m✖\033[0m  $@"; }

### Main
#####################################################################

# Finish.
function finish() {
  # Cleanup.
  local status=$?
  if [ $status != 0 ]; then
    echo -e "\033[1;31mError!"
  else
	echo -e "\033[1;32mFinished!"
  fi
}
trap finish EXIT

# Tweak file globbing.
shopt -s dotglob
shopt -s nullglob

# Start.
log_message "Installing Sublime Text 3 User packages"

# Install Package Control
if [[ ! -e "$INSTALLED_PACKAGES/Package Control.sublime-package" ]]; then
  # Make directory if it doesn't already exist
  mkdir -p "$INSTALLED_PACKAGES"
  # Download Package Control.
  curl -o "$INSTALLED_PACKAGES/Package Control.sublime-package" "https://packagecontrol.io/Package Control.sublime-package"
  log_success "Download Package Control"
fi

# Initialize Sublime directory
if [[ ! -e "$USER_PACKAGES" ]]; then
  # Make the directory
  mkdir -p "$USER_PACKAGES"
  log_success "Created $USER_PACKAGES"
fi

# Symlink Sublime directory if it isn't already
if [[ -d "$USER_PACKAGES" ]] && [[ ! -L "$USER_PACKAGES" ]]; then
  files=("$USER_PACKAGES"/*)
  # # No files?
  if (( ${#files[@]} != 0 )); then
    # Only copy files if they don't already exist
    rsync -a -v -q --ignore-existing "$USER_PACKAGES/" "$DOT_SUBLIME/"
    log_success "Copied existing User packages"
  fi
  # Remove sublime directory
  rm -rf "$USER_PACKAGES"
  # Symlink dotfiles sublime directory
  ln -sf "$DOT_SUBLIME" "$USER_PACKAGES"
  log_success "Linked User packages"
fi
